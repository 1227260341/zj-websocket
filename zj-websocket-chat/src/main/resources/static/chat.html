<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
    <title>My WebSocket-chat</title>
    
    <script src="/jquery/jquery.min.js?v=2.1.4"></script>
    <!-- <link rel="stylesheet" href="/js/layui/css/layui.css"> -->
    <script src="/js/layui/layui.all.js"></script>
    <link rel="stylesheet" href="/css/chat.css">
</head>

<body style="background-image:url(./img/b21c8701a18b87d6ab1de0240c0828381f30fdaa.jpg)">
<div id="welcome" style="background: rgb(238, 238, 238); padding: 5px 10px; border: 1px solid rgb(204, 204, 204);
 border-image: none;font-size: 35px;    line-height: 50px;    text-align: center;height: 50px;">chat
 <img class="addGroup" title="添加群"  src="/img/add.jpg" onclick="addGroup()">
 <img class="off" title="退出"  src="/img/signOut.jpg" onclick="signOut()">
 </div>
 
<div>
	<div id="strangers" class="users">
		<p class="title">陌生人</p>
		<div class="items"> 
		<!-- <div class="item" >
			<img src="/img/timg.jpg">
			<div class="addStranger">
				<p>周振江</p>
				<p class="p_content">这个人什么都没说</p>
			</div>	
		</div> -->
		</div>
	</div>
	
	
	<div id="friends" class="users">
		<p class="title">陈年老友</p>
		<div class="items"> 
		<!-- <div class="item" >
			<img src="/img/timg.jpg">
			<div>
				<p>周振江</p>
				<p class="p_content">内容</p>
			</div>	
		</div> -->
		</div>
	</div>
	
	<div id="chats">
		<div class="title">这是你的小亲亲啊</div>
		<div class="content">
			<!-- <div class="other">
				<div>
					<img src="/img/timg.jpg">
					<p>内容</p>
				</div>
			</div> -->
			
			<!-- <div class="myself">
				<div>
					<img src="/img/timg.jpg">
					<p>内容</p>
				</div>
			</div> -->
			
		</div>
		
		<div class="userChat">
			<input placeholder="请输入聊天内容" /> <button onclick="send()">发送</button>
		</div>
	</div>
	

</div>



<!-- <div style ="width:150px; background-color:white;">
	Welcome<br/>
	<input id="text" type="text" /><button onclick="send()">Send</button>    <button onclick="closeWebSocket()">Close</button>
	<div id="message">
	</div>
</div> -->
</body>

<script type="text/javascript">
    var uid = sessionStorage.getItem("userId");
    var loginUser = sessionStorage.getItem("user");
    if (loginUser == null) {//说明登陆超时
   		alert("登入超时，请重新登陆！");
   		location.href = "/index.html";
   		//return ; 
    }
    loginUser = JSON.parse(loginUser);
    //控制权限
    if (loginUser.type != 1) {
    	//设置群功能隐藏
    	$(".addGroup").css("display", "none");
    } 
    
    console.log("当前登陆人id：" + uid);
    
    $(document).ready(function() {
    	
    	getStrange();
    	getFriends();
    	
    });
    
    document.onkeydown = function(e) {
        var keyCode = e.keyCode || e.which || e.charCode;
        //var ctrlKey = e.ctrlKey || e.metaKey;
        if(objectId != "" && keyCode == 13) {
        	$("#chats .userChat button").click();
        }
        //e.preventDefault();
        //return;
    }
    
    //获取陌生人
    function getStrange() {
    	$.ajax({
			url:"/user/getStranger",
			type:"GET",
			//data:params,
			dataType:"json",
			success:function(res) {
				if(res.code == 0) {
					console.log("获取成功！");
					var userList = res.data;
					if (userList == null){
						return ;
					}
					
					$("#strangers .items").html("");
					
					//实现陌生人列表
					for(var i = 0; i < res.data.length; i ++) {
						var item = res.data[i];
						var head = "/img/timg.jpg";
						if (item.head != null && item.head != "") {
							head = item.headUrl;
						}
						var html = "<div class='item' onclick='addStranger("+ item.id +")'>";
						html += "<img src='"+ head +"'>";
						html += "<div >";
						html += "<p>"+ item.userName +"</p>";
						html += "<p class='p_content'>这个人什么都没说</p>";
						html += "</div>";
						html += "</div>";
						
						$("#strangers .items").append(html);
					}
				} else {
					alert(res.message);
					if (res.code == 1) {//说名session 过期则需要重新登录
						location.href = "/index.html";
						return ;
					}
				}
			}
		});
    }
    
    //获取好友
    function getFriends() {
    
    	$.ajax({
			url:"/user/getFriends",
			type:"GET",
			//data:params,
			dataType:"json",
			success:function(res) {
				if(res.code == 0) {
					$("#friends .items").html("");
					console.log("获取成功！");
					var userList = res.data;
					if (userList != null && userList.length > 0){
						//实现好友列表
						for(var i = 0; i < res.data.length; i ++) {
							var item = res.data[i];
							var head = "/img/timg.jpg";
							if (item.head != null && item.head != "") {
								head = item.headUrl;
							}
							var html = "<div class='item' onclick='click1("+ item.id +", \""+ item.userName +"\")'  ondblclick='dblclick("+ item.id +", \""+ item.userName +"\")' >";
							html += "<img src='"+ head +"'>";
							html += "<div>";
							html += "<p>"+ item.userName +"</p>";
							html += "<p class='p_content'>猜猜我是谁！</p>";
							html += "</div>";
							html += "</div>";
							
							$("#friends .items").append(html);
						}
					}
					
					//渲染上群组
					var groupList = res.group;
					if (groupList != null && groupList.length > 0) {
						var display = "";
						if (loginUser.type != 1) {
							display = "none";
						}
						//实现群组
						for(var i = 0; i < groupList.length; i ++) {
							var item = groupList[i];
							var head = "/img/group.jpg";
							var html = "<div class='item' onclick='clickGroup("+ item.id +", \""+ item.name +"\")'  ondblclick='dblclickGroup("+ item.id +", \""+ item.name +"\")' >";
							html += "<img src='"+ head +"'>";
							html += "<div>";
							html += "<p>"+ item.name +"</p>";
							html += "<p class='p_content'>这是正规群！</p>";
							html += "</div>";
							html += "<img class='g_img' onclick='addGroupUser("+ item.id +", event)' src='/img/add.jpg' style='display:"+display+"'>";
							html += "</div>";
							
							$("#friends .items").append(html);
						}
					}
					
				} else {
					alert(res.message);
					if (res.code == 1) {//说名session 过期则需要重新登录
						location.href = "/index.html";
						return ;
					}
				}
			}
		});
    }
    
    //添加陌生人
    function addStranger(userId) {
    	if (!confirm("是否确定添加该用户？")) {
    		return ;
    	}
    	
    	$.ajax({
			url:"/user/addFriend?objectId=" + userId,
			type:"GET",
			//data:params,
			dataType:"json",
			success:function(res) {
				if(res.code == 0) {
					getStrange();
    				getFriends();
					
				} else {
					alert(res.message);
					if (res.code == 1) {//说名session 过期则需要重新登录
						location.href = "/index.html";
					}
				}
			}
		});
    	
    }
    
    var time = null;
	//单击事件
	function click1(id, userName){
		//取消上次延时未执行的方法
		clearTimeout(time);
		//设置延时300ms
		time = setTimeout(function(){
			//在此写单击事件要执行的代码
			chatWithFriend(id, userName);
		},300);
	}
	 
	//双击事件
	function dblclick(id, userName){
		//取消上次延时未执行的方法
		clearTimeout(time);
		//下面写双击事件要执行的代码
		console.log("这是双击");
		delFriend(id);
		
	}
	
	var timeGroup = null;
	//单击事件
	function clickGroup(id, name){
		//取消上次延时未执行的方法
		clearTimeout(timeGroup);
		//设置延时300ms
		time = setTimeout(function(){
			//在此写单击事件要执行的代码
			chatWithFriend(id, name, 2);
		},300);
	}
	 
	//双击事件
	function dblclickGroup(id, name){
		//取消上次延时未执行的方法
		clearTimeout(time);
		//下面写双击事件要执行的代码
		console.log("这是双击");
		delGroup(id);
		
	}
    
    
    //添加陌生人
    function delFriend(userId) {
    	if (!confirm("是否确定删除该用户？")) {
    		return ;
    	}
    	$.ajax({
			url:"/user/delFriend?objectId=" + userId,
			type:"GET",
			//data:params,
			dataType:"json",
			success:function(res) {
				if(res.code == 0) {
					
					getStrange();
    				getFriends();
					
				} else {
					alert(res.message);
					if (res.code == 1) {//说名session 过期则需要重新登录
						location.href = "/index.html";
					}
				}
			}
		});
    	
    }
    
    var objectId = "";
    var openNew = true;//默认为true 是初始页面时也未打开页面，或打开的第一个也是new的窗口
    var isGroup = 1;//1 好友消息 ，2 群
    var sessionObjectId = "";//主要用于区分 群id 跟好友id
    //聊天
    function chatWithFriend(id, userName, group,e) {
    	//e.stopPropagation();
		//e.preventDefault(); 
		var objId = "";
		if (group == 2) {
			isGroup = 2;
			objId = "group_" + id;
		} else {
			isGroup = 1;
			objId = "friend_" + id;
		}
    	console.log("----chatWithFriend--------聊天对象id=" + id);
    	//显示聊天窗口
    	$("#chats").css("display", "block");
    	
    	
    	if (sessionObjectId != "" && sessionObjectId != objId) {//说明新有开启消息
    		$("#chats .content").html("");
    		openNew = true;
    	} else if (sessionObjectId == objId) {//说明点击的是自身(即已经展开的聊天页面)
    		openNew = false;
    		return ;
    	} 
    	/* if (objectId != "" && objectId != id) {//说明新有开启消息
    		$("#chats .content").html("");
    		openNew = true;
    	} else if (objectId == id) {//说明点击的是自身(即已经展开的聊天页面)
    		openNew = false;
    		return ;
    	}  */
    	//获取以往记录数
		getMessageRecord(id, isGroup);
    	$("#chats .title").html(userName);
    	objectId = id;//给全局变量赋值
    	if (isGroup == 2) {
    		sessionObjectId = "friend_" + id;
    	} else {
    		sessionObjectId = "group_" + id;
    	}
    	
    }
    
    //此处写法先后顺序问题 所以不能实现
    //$('#strangers .item').on('click',function(){alert("--------")}); 
    
    
    
    
    
    //webscoket 
    var websocket = null;

    //判断当前浏览器是否支持WebSocket
    if('WebSocket' in window){
        websocket = new WebSocket("ws://localhost:9091/chat");
    	//websocket = new WebSocket("ws://www.6768737.com:9091/chat");
    }
    else{
        alert('Not support websocket')
    }

    //连接发生错误的回调方法
    websocket.onerror = function(){
        setMessageInnerHTML("error");
    };

    //连接成功建立的回调方法
    websocket.onopen = function(event){
        setMessageInnerHTML("open");
    }

    //接收到消息的回调方法
    websocket.onmessage = function(event){
    	if (event.data == null) {
    		return ;
    	}
        setMessageInnerHTML(event.data);
    }

    //连接关闭的回调方法
    websocket.onclose = function(){
        setMessageInnerHTML("close");
    }

    //监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。
    window.onbeforeunload = function(){
        websocket.close();
    }

    //将消息显示在网页上
    function setMessageInnerHTML(data){
    	
    	try {
    		data = JSON.parse(data);
    	} catch (e) {
    		console.log("---setMessageInnerHTML--" + data);
    		return ;
    	}
    	
		var sendUserId = data.sendUserId;//发送消息过来的id
		
		if (data.type == 2) {//说明是群消息
			if (openNew && objectId != data.groupId && isGroup != 2) {//说明打开了 和其他人聊天的窗口 则接入其他的消息 提醒，但不渲染上去(如：非本群组的聊天窗口 或好友聊天窗口)
				layer.msg("少年你收到了一条来自群的消息！");
				return;
			}
		} else {
			if (openNew && objectId != sendUserId) {//说明打开了 和其他人聊天的窗口 则接入其他的消息 提醒，但不渲染上去
				alert("少年你收到了一条消息！");
				return;
			}
		}
		
    	renderOtherHtml(data.message, data.sendUserHead);
    	//将滚动条滚动之div最底部
		$("#chats .content").scrollTop($("#chats .content")[0].scrollHeight);
    }

    //关闭连接
    function closeWebSocket(){
        websocket.close();
    }

    //发送消息
    function send(){
    	var content = $("#chats input").val();//获取到发送的内容
    	if (content == null || content == "") {
    		//alert("");
    		console.log("未输入消息");
    		return ;
    	}
    	console.log("发送的消息！" + content + "需要发送的对象id=" + objectId);
    	var params = {
    		message:content,//此处只为对象方便接收
    		content:content,
    		objectId:objectId,
    		type:isGroup//1 好友， 2 群
    	}
    	//添加消息 入库
        addChatMessage(params);
    	if (isGroup == 2) {//说明是群组 
    		//获取到群组的用户
    		$.ajax({
    			url:"/user/getGroupById?groupId=" + objectId,
    			type:"GET",
    			data:params,
    			dataType:"json",
    			async:false,
    			success:function(res) {
    				if(res.code == 0) {
    					params.groupUserIds = res.data;
    				} else {
    					alert(res.message);
    				}
    			}
    		});
    	}
    	params = JSON.stringify(params);
        websocket.send(params);
        
        //清空发送的消息
        $("#chats input").val("");
		
		//渲染是消息
        renderMyselfHtml(content, loginUser.headUrl);
		
      	//将滚动条滚动之div最底部
		$("#chats .content").scrollTop($("#chats .content")[0].scrollHeight);
    }
    
    //将消息入库
    function addChatMessage(params) {
    	$.ajax({
			url:"/user/addChatMessage",
			type:"GET",
			data:params,
			dataType:"json",
			success:function(res) {
				if(res.code == 0) {
					console.log("入库消息成功 ! ");
				} else {
					alert(res.message);
				}
			}
		});
    }
    
    //获取聊天记录-
    function getMessageRecord(id, isGroup) {
    	//获取笑嘻嘻记录
    	$.ajax({
			url:"/user/getMessageRecord?objectId=" + id + "&isGroup=" + isGroup,
			type:"GET",
			//data:params,
			dataType:"json",
			success:function(res) {
				if(res.code == 0) {
					var data = res.data;
					if (data == null || data.length < 1) {
						return ;
					}
					
					//渲染上数据
					for (var i = data.length - 1; i >= 0; i --) {
						var item = data[i];
						if (item.userId == uid) {//说明是本人
							renderMyselfHtml(item.message, item.head);
						} else {//非本人
							renderOtherHtml(item.message, item.head);
						}
					}
					
					//将滚动条滚动之div最底部
					$("#chats .content").scrollTop($("#chats .content")[0].scrollHeight);
					
				} else {
					alert(res.message);
				}
			}
		});
    }
    
    //渲染其他人消息
    function renderOtherHtml(message, head) {
    	if (head == null || head == "") {
    		head = "/img/timg.jpg";
    	}
    	var html = "<div class='other'>";
		html += "<div>";
		html += "<img src='"+ head +"'>";
		html += "<p>" + message + "</p>";
		html += "</div>";
		html += "</div>";
		$("#chats .content").append(html);
    }
    
  	//渲染自己的消息
    function renderMyselfHtml(message, head) {
    	 //自身发的消息先 渲染上去
    	if (head == null || head == "") {
    		head = "/img/timg.jpg";
    	}
        var html = "<div class='myself'>";
		html += "<div>";
		html += "<img src='"+ head +"'>";
		html += "<p>" + message + "</p>";
		html += "</div>";
		html += "</div>";
		$("#chats .content").append(html);
    }
  	
  	//注销 退出
    function signOut() {
    	console.log("退出");
    	
    	if (!confirm("是否确定退出？")) {
    		return ;
    	}
    	
    	$.ajax({
			url:"/user/signOut",
			type:"GET",
			//data:params,
			dataType:"json",
			success:function(res) {
				if(res.code == 0) {
					location.href = "/index.html";		
				} else {
					alert(res.message);
				}
			}
		});
    }
  	
  	//添加群-该操作只能是管理员 才可以创建
  	function addGroup() {
  		layer.open({
  		  type: 2,
  		  title: '添加群',
  		  shadeClose: true,
  		  shade: 0.8,
  		  area: ['300px', '210px'],
  		  content: '/view/addGroup.html', //iframe的url
  		  /* //只有当点击confirm框的确定时，该层才会关闭
          cancel: function(index){ 
            if(confirm('确定要关闭么')){
              layer.close(index);
            }
            return false; 
          } */
  		}); 
  	}
  	
  	//添加群组成员
  	function addGroupUser(id, e) {
  		e.preventDefault();
  		e.stopPropagation();
  		
  		layer.open({
    		  type: 2,
    		  title: '设追群成员',
    		  shadeClose: true,
    		  shade: 0.8,
    		  area: ['700px', '460px'],
    		  content: '/view/addGroupUser.html?groupId=' + id, //iframe的url
    		}); 
  		
  	}
  	



    
</script>
</html>